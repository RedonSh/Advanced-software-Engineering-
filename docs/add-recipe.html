<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecipeSite — Add Recipe</title>
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/recipe.css" />

  <script>
    window.ENV_SUPABASE_URL = 'https://bhqeasmtrdfqncliipki.supabase.co/';
    window.ENV_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJocWVhc210cmRmcW5jbGlpcGtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNzQ4NzgsImV4cCI6MjA3NzY1MDg3OH0.249y8yGBYKgcvnoKkdTft94Mu74kbO_Ioso2HFrTFpg';
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"
          onload="window.supabase = window.supabase.createClient(ENV_SUPABASE_URL, ENV_SUPABASE_KEY, {auth:{persistSession:true, autoRefreshToken:true}})"></script>

  <script src="js/common.js" defer></script>
</head>
<body>
  <header class="site-head">
    <div class="container">
      <nav class="nav"><a href="recipes.html#browse">← Back to Recipes</a></nav>
    </div>
  </header>

  <main class="container">
    <h1>Add a New Recipe</h1>
    <div id="alert" style="margin-bottom:12px;padding:10px;border-radius:8px;background:#fee;color:#c00;border:1px solid #e00" hidden></div>

    <form id="addForm" class="card" style="display:grid; gap:24px;" enctype="multipart/form-data">
      
      <!-- Basic Info -->
      <div class="row" style="gap:16px; flex-wrap:wrap;">
        <label class="field" style="flex:2; min-width:200px;">
          <span>Recipe Title</span>
          <input id="rTitle" type="text" required placeholder="e.g. Classic Lasagna" />
        </label>
        <label class="field" style="flex:1; min-width:140px;">
          <span>Category</span>
          <input id="rCat" type="text" list="catList" placeholder="e.g. Dinner" required />
          <datalist id="catList">
            <option>Dinner</option><option>Lunch</option><option>Breakfast</option><option>Dessert</option>
          </datalist>
        </label>
      </div>

      <!-- Image upload instead of URL -->
      <label class="field">
        <span>Image</span>
        <input id="rImgFile" type="file" accept="image/*" />
        <small class="muted">Upload a photo of your recipe (optional).</small>
      </label>

      <!-- Details -->
      <div class="row" style="gap:16px; flex-wrap:wrap;">
        <label class="field" style="flex:1">
          <span>Ingredients (one per line)</span>
          <textarea id="rIng" rows="6" required placeholder="2 cups flour&#10;1 tsp salt&#10;..."></textarea>
        </label>
        <label class="field" style="flex:1">
          <span>Steps (one per line)</span>
          <textarea id="rSteps" rows="6" required placeholder="Mix ingredients.&#10;Bake at 180°C.&#10;..."></textarea>
        </label>
      </div>

      <!-- Nutrition -->
      <fieldset style="border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
        <legend style="padding:0 8px; color:#666; font-weight:600;">Nutrition (optional)</legend>
        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <label class="field" style="flex:1"><span>Calories</span><input type="number" id="nCal" placeholder="0" /></label>
          <label class="field" style="flex:1"><span>Protein (g)</span><input type="number" id="nPro" placeholder="0" /></label>
          <label class="field" style="flex:1"><span>Carbs (g)</span><input type="number" id="nCarb" placeholder="0" /></label>
          <label class="field" style="flex:1"><span>Fat (g)</span><input type="number" id="nFat" placeholder="0" /></label>
        </div>
      </fieldset>

      <button class="btn full" type="submit">Save Recipe</button>
    </form>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const alertBox = document.getElementById('alert');
      const form = document.getElementById('addForm');

      function showErr(m) { 
        alertBox.textContent = m; 
        alertBox.hidden = false; 
        window.scrollTo(0,0); 
      }

      // 1. Wait for auth check – user must be logged in to add recipes
      const check = setInterval(async () => {
        if (window.supabase) {
          clearInterval(check);
          const { data } = await supabase.auth.getSession();
          if (!data.session) {
            alert('You must be signed in to add recipes.');
            window.location.href = 'index.html?next=add-recipe.html';
          }
        }
      }, 100);

      // Helper: upload image to Supabase Storage and return public URL
      async function uploadRecipeImage(file) {
        if (!file) return null;

        // Make sure storage client exists
        if (!window.supabase || !supabase.storage) {
          throw new Error('Supabase storage is not available.');
        }

        // Get user id for path (fallback to "anon" if something weird happens)
        let userId = null;
        try {
          const { data } = await supabase.auth.getUser();
          userId = data?.user?.id || null;
        } catch (e) {
          console.warn('getUser failed in uploadRecipeImage', e);
        }
        const uid = userId || 'anon';

        // Build a unique file path
        const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
        const path = `${uid}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;

        // Upload to bucket "recipes"
        const { data, error } = await supabase
          .storage
          .from('recipes')
          .upload(path, file);

        if (error) {
          console.error('Image upload error', error);
          throw new Error('Image upload failed: ' + error.message);
        }

        const { data: publicData } = supabase
          .storage
          .from('recipes')
          .getPublicUrl(data.path);

        return publicData.publicUrl;
      }

      // 2. Handle Submit
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        alertBox.hidden = true;

        try {
          const title = document.getElementById('rTitle').value.trim();
          const cat = document.getElementById('rCat').value.trim();
          const fileInput = document.getElementById('rImgFile');
          const file = fileInput.files && fileInput.files[0];

          // Split textareas by newlines and remove empty lines
          const ingredients = document.getElementById('rIng').value
            .split('\n').map(s=>s.trim()).filter(s=>s);
          const steps = document.getElementById('rSteps').value
            .split('\n').map(s=>s.trim()).filter(s=>s);

          const calories = parseInt(document.getElementById('nCal').value) || 0;
          const protein = parseInt(document.getElementById('nPro').value) || 0;
          const carbs = parseInt(document.getElementById('nCarb').value) || 0;
          const fat = parseInt(document.getElementById('nFat').value) || 0;

          if (!title || !cat) {
            showErr('Please fill in the title and category.');
            return;
          }
          if (!ingredients.length || !steps.length) {
            showErr('Please provide at least one ingredient and one step.');
            return;
          }

          // Upload image if provided
          let imageUrl = null;
          if (file) {
            imageUrl = await uploadRecipeImage(file);
          }

          const payload = {
            title,
            category: cat,
            image: imageUrl,
            ingredients,
            steps,
            calories,
            protein,
            carbs,
            fat
          };

          const newRecipe = await RecipeSite.addRecipe(payload);
          
          if (newRecipe && newRecipe.id) {
             window.location.href = 'recipe-detail.html?id=' + newRecipe.id;
          } else {
             // If RLS allows insert but doesn't return rows, just go back to list
             window.location.href = 'recipes.html#browse';
          }

        } catch (err) {
          console.error(err);
          showErr('Error saving recipe: ' + err.message);
        }
      });
    });
  </script>
</body>
</html>
