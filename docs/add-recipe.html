<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecipeSite — Add Recipe</title>

  <!-- Same CSS stack as recipes page -->
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/recipes.css" />
  <link rel="stylesheet" href="css/recipe.css" />

  <!-- Supabase env -->
  <script>
    window.ENV_SUPABASE_URL = 'https://bhqeasmtrdfqncliipki.supabase.co/';
    window.ENV_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJocWVhc210cmRmcW5jbGlpcGtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNzQ4NzgsImV4cCI6MjA3NzY1MDg3OH0.249y8yGBYKgcvnoKkdTft94Mu74kbO_Ioso2HFrTFpg';
  </script>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"
          onload="
            try {
              window.supabase = window.supabase.createClient(
                window.ENV_SUPABASE_URL,
                window.ENV_SUPABASE_KEY,
                { auth:{ persistSession:true, autoRefreshToken:true } }
              );
            } catch(e) { console.error('[supabase] init error', e); }
          "></script>

  <!-- Shared helpers -->
  <script src="js/common.js"></script>

  <!-- Header + alert styling copied to match recipes.html -->
  <style>
    .site-head{
      position:sticky;
      top:0;
      z-index:50;
      backdrop-filter:saturate(120%) blur(6px);
      background:color-mix(in oklab,var(--card,#fff),transparent 15%);
      border-bottom:1px solid #0001;
    }
    .site-head .wrap{
      display:flex;
      gap:16px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      padding-block:10px;
    }
    .brand{
      display:flex;
      gap:10px;
      align-items:center;
      font-weight:700;
      text-decoration:none;
      color:inherit;
    }
    .brand svg{
      width:22px;
      height:22px;
    }
    .nav{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .nav a{
      padding:6px 10px;
      border-radius:999px;
      text-decoration:none;
      color:inherit;
      border:1px solid transparent;
    }
    .nav a[aria-current="page"]{
      background:color-mix(in oklab,var(--accent,#16a34a),white 85%);
      border-color:#00000010;
    }
    .head-search{
      flex:1;
      min-width:220px;
      max-width:480px;
    }
    .head-search input{
      width:100%;
    }
    .alert{
      margin:12px 0;
      padding:10px 12px;
      border:1px solid #e11;
      border-radius:10px;
      background:#fee;
      color:#700;
    }
  </style>
</head>
<body>
  <!-- HEADER: identical structure to recipes.html -->
  <header class="site-head">
    <div class="container wrap">
      <a href="recipes.html#browse" class="brand">
        <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M8 3a1 1 0 0 0-1 1v2h10a1 1 0 1 1 0 2H7v2h8.5a3.5 3.5 0 1 1 0 7H12v2h4.5a5.5 5.5 0 0 0 0-11H6V4a1 1 0 0 1 1-1h1z"/>
        </svg>
        <span>RecipeSite</span>
      </a>

      <nav class="nav">
        <a href="recipes.html#browse">Browse</a>
        <a href="recipes.html#pantry">Pantry</a>
        <a href="recipes.html#favourites">Favourites</a>
      </nav>

      <div class="head-search">
        <input id="globalSearch" type="search" placeholder="Search all recipes..." />
      </div>
      
      <div class="auth" style="min-width: 120px; text-align: right;"></div>
    </div>
  </header>

  <main class="container" style="padding-top:24px; padding-bottom:24px;">
    <h1>Add a New Recipe</h1>
    <div id="alert" class="alert" hidden></div>

    <form id="addForm" class="card" style="display:grid; gap:24px;" enctype="multipart/form-data">
      <!-- Basic Info -->
      <div class="row" style="gap:16px; flex-wrap:wrap;">
        <label class="field" style="flex:2; min-width:200px;">
          <span>Recipe Title</span>
          <input id="rTitle" type="text" required placeholder="e.g. Classic Lasagna" />
        </label>
        <label class="field" style="flex:1; min-width:140px;">
          <span>Category</span>
          <input id="rCat" type="text" list="catList" placeholder="e.g. Dinner" required />
          <datalist id="catList">
            <option>Dinner</option>
            <option>Lunch</option>
            <option>Breakfast</option>
            <option>Dessert</option>
          </datalist>
        </label>
      </div>

      <!-- Image upload -->
      <label class="field">
        <span>Image</span>
        <input id="rImgFile" type="file" accept="image/*" />
        <small class="muted">Upload a photo of your recipe (optional).</small>
      </label>

      <!-- Details -->
      <div class="row" style="gap:16px; flex-wrap:wrap;">
        <label class="field" style="flex:1">
          <span>Ingredients (one per line)</span>
          <textarea id="rIng" rows="6" required placeholder="2 cups flour&#10;1 tsp salt&#10;..."></textarea>
        </label>
        <label class="field" style="flex:1">
          <span>Steps (one per line)</span>
          <textarea id="rSteps" rows="6" required placeholder="Mix ingredients.&#10;Bake at 180°C.&#10;..."></textarea>
        </label>
      </div>

      <!-- Nutrition -->
      <fieldset style="border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
        <legend style="padding:0 8px; color:#666; font-weight:600;">Nutrition (optional)</legend>
        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <label class="field" style="flex:1">
            <span>Calories</span>
            <input type="number" id="nCal" placeholder="0" />
          </label>
          <label class="field" style="flex:1">
            <span>Protein (g)</span>
            <input type="number" id="nPro" placeholder="0" />
          </label>
          <label class="field" style="flex:1">
            <span>Carbs (g)</span>
            <input type="number" id="nCarb" placeholder="0" />
          </label>
          <label class="field" style="flex:1">
            <span>Fat (g)</span>
            <input type="number" id="nFat" placeholder="0" />
          </label>
        </div>
      </fieldset>

      <button class="btn full" type="submit">Save Recipe</button>
    </form>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const alertBox = document.getElementById('alert');
      const form = document.getElementById('addForm');

      function showErr(m) {
        alertBox.textContent = m;
        alertBox.hidden = false;
        window.scrollTo(0, 0);
      }

      /* ===== Header auth UI to match recipes page ===== */
      async function updateAuthUI() {
        const authContainer = document.querySelector('header .auth');
        if (!authContainer || !window.supabase) return;

        const { data } = await supabase.auth.getSession();
        const session = data?.session || null;

        if (!session || !session.user) {
          const next = encodeURIComponent('add-recipe.html');
          authContainer.innerHTML = `<a class="btn small outline" href="index.html?next=${next}">Sign in</a>`;
        } else {
          const user = session.user;
          const displayName = user.user_metadata?.username || user.email.split('@')[0];
          authContainer.innerHTML = `
            <span style="font-size: 0.9rem; margin-right: 12px;">Hi, ${displayName}</span>
            <button class="btn small outline" id="logoutButton">Logout</button>
          `;
          authContainer.querySelector('#logoutButton').addEventListener('click', async () => {
            try {
              await supabase.auth.signOut();
              window.location.href = 'recipes.html#browse';
            } catch (e) {
              console.error('signOut error', e);
            }
          });
        }
      }

      // Keep header auth in sync
      if (window.supabase) {
        updateAuthUI();
        supabase.auth.onAuthStateChange(() => updateAuthUI());
      } else {
        const check = setInterval(() => {
          if (window.supabase) {
            clearInterval(check);
            updateAuthUI();
            supabase.auth.onAuthStateChange(() => updateAuthUI());
          }
        }, 100);
      }

      // Require login to add recipes
      const authCheck = setInterval(async () => {
        if (!window.supabase) return;
        const { data } = await supabase.auth.getSession();
        if (!data.session) {
          clearInterval(authCheck);
          alert('You must be signed in to add recipes.');
          window.location.href = 'index.html?next=add-recipe.html';
        } else {
          clearInterval(authCheck);
        }
      }, 100);

      // Simple behaviour for header search: redirect back to Browse with a query param
      const globalSearch = document.getElementById('globalSearch');
      if (globalSearch) {
        globalSearch.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            const q = encodeURIComponent(globalSearch.value.trim());
            window.location.href = q
              ? `recipes.html#browse?q=${q}`
              : 'recipes.html#browse';
          }
        });
      }

      // Helper: upload image to Supabase Storage and return public URL
      async function uploadRecipeImage(file) {
        if (!file) return null;

        if (!window.supabase || !supabase.storage) {
          throw new Error('Supabase storage is not available.');
        }

        let userId = null;
        try {
          const { data } = await supabase.auth.getUser();
          userId = data?.user?.id || null;
        } catch (e) {
          console.warn('getUser failed in uploadRecipeImage', e);
        }
        const uid = userId || 'anon';

        const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
        const path = `${uid}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;

        const { data, error } = await supabase
          .storage
          .from('recipes')
          .upload(path, file);

        if (error) {
          console.error('Image upload error', error);
          throw new Error('Image upload failed: ' + error.message);
        }

        const { data: publicData } = supabase
          .storage
          .from('recipes')
          .getPublicUrl(data.path);

        return publicData.publicUrl;
      }

      // Handle Submit
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        alertBox.hidden = true;

        try {
          const title = document.getElementById('rTitle').value.trim();
          const cat = document.getElementById('rCat').value.trim();
          const fileInput = document.getElementById('rImgFile');
          const file = fileInput.files && fileInput.files[0];

          const ingredients = document.getElementById('rIng').value
            .split('\n').map(s => s.trim()).filter(s => s);
          const steps = document.getElementById('rSteps').value
            .split('\n').map(s => s.trim()).filter(s => s);

          const calories = parseInt(document.getElementById('nCal').value) || 0;
          const protein = parseInt(document.getElementById('nPro').value) || 0;
          const carbs = parseInt(document.getElementById('nCarb').value) || 0;
          const fat = parseInt(document.getElementById('nFat').value) || 0;

          if (!title || !cat) {
            showErr('Please fill in the title and category.');
            return;
          }
          if (!ingredients.length || !steps.length) {
            showErr('Please provide at least one ingredient and one step.');
            return;
          }

          let imageUrl = null;
          if (file) {
            imageUrl = await uploadRecipeImage(file);
          }

          const payload = {
            title,
            category: cat,
            image: imageUrl,
            ingredients,
            steps,
            calories,
            protein,
            carbs,
            fat
          };

          const newRecipe = await RecipeSite.addRecipe(payload);

          if (newRecipe && newRecipe.id) {
            window.location.href = 'recipe-detail.html?id=' + newRecipe.id;
          } else {
            window.location.href = 'recipes.html#browse';
          }

        } catch (err) {
          console.error(err);
          showErr('Error saving recipe: ' + err.message);
        }
      });
    });
  </script>
</body>
</html>
