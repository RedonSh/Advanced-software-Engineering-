<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecipeSite — Add Recipe</title>
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/recipe.css" />

  <script>
    window.ENV_SUPABASE_URL = 'https://bhqeasmtrdfqncliipki.supabase.co/';
    window.ENV_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJocWVhc210cmRmcW5jbGlpcGtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNzQ4NzgsImV4cCI6MjA3NzY1MDg3OH0.249y8yGBYKgcvnoKkdTft94Mu74kbO_Ioso2HFrTFpg';
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"
          onload="
            try {
              window.supabase = window.supabase.createClient(
                window.ENV_SUPABASE_URL,
                window.ENV_SUPABASE_KEY,
                { auth:{ persistSession:true, autoRefreshToken:true } }
              );
            } catch(e) { console.error('[supabase] init error', e); }
          "></script>

  <script src="js/common.js"></script>
</head>
<body>
  <header class="site-head">
    <div class="container wrap">
      <a href="recipes.html#browse" class="brand">
        <svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;" aria-hidden="true">
          <path d="M8 3a1 1 0 0 0-1 1v2h10a1 1 0 1 1 0 2H7v2h8.5a3.5 3.5 0 1 1 0 7H12v2h4.5a5.5 5.5 0 0 0 0-11H6V4a1 1 0 0 1 1-1h1z"/>
        </svg>
        <span>RecipeSite</span>
      </a>

      <nav class="nav">
        <a href="recipes.html#browse">Browse</a>
        <a href="recipes.html#pantry">Pantry</a>
        <a href="recipes.html#favourites">Favourites</a>
      </nav>

      <div style="flex:1"></div>
      <div class="auth"><!-- common.js handles auth UI --></div>
    </div>
  </header>

  <main class="container">
    <h1>Add a New Recipe</h1>
    <div id="alert" style="margin-bottom:12px;padding:10px;border-radius:10px;background:#fee;color:#c00;border:1px solid #e00" hidden></div>

    <form id="addForm" class="card" style="display:grid; gap:24px;" enctype="multipart/form-data">
      
      <!-- Basic Info -->
      <div class="row" style="gap:16px; flex-wrap:wrap;">
        <label class="field" style="flex:2; min-width:200px;">
          <span>Recipe Title</span>
          <input id="rTitle" type="text" required placeholder="e.g. Classic Lasagna" />
        </label>
        <label class="field" style="flex:1; min-width:140px;">
          <span>Category</span>
          <input id="rCat" type="text" list="catList" placeholder="e.g. Dinner" required />
          <datalist id="catList">
            <option>Breakfast</option>
            <option>Lunch</option>
            <option>Dinner</option>
            <option>Dessert</option>
            <option>Snack</option>
          </datalist>
        </label>
      </div>

      <!-- Image upload -->
      <label class="field">
        <span>Image</span>
        <input id="rImgFile" type="file" accept="image/*" />
        <small class="muted">Upload a photo of your recipe (optional).</small>
      </label>

      <!-- Details -->
      <div class="row" style="gap:16px; flex-wrap:wrap;">
        <label class="field" style="flex:1">
          <span>Ingredients (one per line)</span>
          <textarea id="rIng" rows="6" required placeholder="2 cups flour&#10;1 tsp salt&#10;..."></textarea>
        </label>
        <label class="field" style="flex:1">
          <span>Steps (one per line)</span>
          <textarea id="rSteps" rows="6" required placeholder="Mix ingredients.&#10;Bake at 180°C.&#10;..."></textarea>
        </label>
      </div>

      <!-- Nutrition -->
      <fieldset style="border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
        <legend style="padding:0 8px; color:#666; font-weight:600;">Nutrition (optional)</legend>
        <div class="row" style="gap:12px; flex-wrap:wrap;">
          <label class="field" style="flex:1"><span>Calories</span><input type="number" id="nCal" placeholder="0" /></label>
          <label class="field" style="flex:1"><span>Protein (g)</span><input type="number" id="nPro" placeholder="0" /></label>
          <label class="field" style="flex:1"><span>Carbs (g)</span><input type="number" id="nCarb" placeholder="0" /></label>
          <label class="field" style="flex:1"><span>Fat (g)</span><input type="number" id="nFat" placeholder="0" /></label>
        </div>
      </fieldset>

      <button class="btn full" type="submit">Save Recipe</button>
    </form>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const alertBox = document.getElementById('alert');
      const form = document.getElementById('addForm');

      const heading = document.querySelector('main h1');
      const submitBtn = form.querySelector('button[type="submit"]');

      function showErr(m) {
        alertBox.textContent = m;
        alertBox.hidden = false;
        window.scrollTo(0, 0);
      }

      const params = new URLSearchParams(location.search);
      const editId = params.get('id');
      const isEditMode = !!editId;
      let existingImageUrl = null;

      if (isEditMode) {
        if (heading) heading.textContent = 'Edit Recipe';
        if (submitBtn) submitBtn.textContent = 'Save Changes';
      }

      // Ensure user is logged in and, in edit mode, load existing recipe
      async function initAuthAndMaybeLoad() {
        const { data, error } = await supabase.auth.getSession();
        if (error) {
          console.error('[auth] getSession error', error);
          showErr('Could not check login status.');
          return;
        }

        const session = data?.session;
        if (!session) {
          alert('You must be signed in to add recipes.');
          const next = isEditMode
            ? 'add-recipe.html?id=' + encodeURIComponent(editId)
            : 'add-recipe.html';
          window.location.href = 'index.html?next=' + next;
          return;
        }

        if (isEditMode) {
          await loadExistingRecipe(editId, session.user);
        }
      }

      async function loadExistingRecipe(id, user) {
        try {
          const { data: recipe, error } = await supabase
            .from('recipes')
            .select('id, title, category, ingredients, steps, image, calories, protein, carbs, fat, user_id')
            .eq('id', id)
            .maybeSingle();

          if (error) {
            console.error('[edit] load error', error);
            showErr('Could not load recipe for editing.');
            return;
          }
          if (!recipe) {
            showErr('Recipe not found.');
            return;
          }

          if (recipe.user_id && user && recipe.user_id !== user.id) {
            showErr('You can only edit your own recipes.');
            setTimeout(() => { window.location.href = 'recipes.html#browse'; }, 1500);
            return;
          }

          document.getElementById('rTitle').value = recipe.title || '';
          document.getElementById('rCat').value = recipe.category || '';
          document.getElementById('rIng').value = Array.isArray(recipe.ingredients)
            ? recipe.ingredients.join('\n')
            : '';
          document.getElementById('rSteps').value = Array.isArray(recipe.steps)
            ? recipe.steps.join('\n')
            : '';

          document.getElementById('nCal').value = recipe.calories ?? '';
          document.getElementById('nPro').value = recipe.protein ?? '';
          document.getElementById('nCarb').value = recipe.carbs ?? '';
          document.getElementById('nFat').value = recipe.fat ?? '';

          existingImageUrl = recipe.image || null;
        } catch (err) {
          console.error('[edit] unexpected load error', err);
          showErr('Could not load recipe for editing.');
        }
      }

      // Helper: upload image to Supabase Storage and return public URL
      async function uploadRecipeImage(file) {
        if (!file) return null;

        if (!window.supabase || !supabase.storage) {
          throw new Error('Supabase storage is not available.');
        }

        let userId = null;
        try {
          const { data } = await supabase.auth.getUser();
          userId = data?.user?.id || null;
        } catch (e) {
          console.warn('getUser failed in uploadRecipeImage', e);
        }
        const uid = userId || 'anon';

        const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
        const path = `${uid}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;

        const { data, error } = await supabase
          .storage
          .from('recipes')
          .upload(path, file);

        if (error) {
          console.error('Image upload error', error);
          throw new Error('Image upload failed: ' + error.message);
        }

        const { data: publicData } = supabase
          .storage
          .from('recipes')
          .getPublicUrl(data.path);

        return publicData.publicUrl;
      }

      // Handle submit for both add + edit
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        alertBox.hidden = true;

        try {
          const title = document.getElementById('rTitle').value.trim();
          const cat = document.getElementById('rCat').value.trim();
          const fileInput = document.getElementById('rImgFile');
          const file = fileInput.files && fileInput.files[0];

          const ingredients = document.getElementById('rIng').value
            .split('\n').map(s => s.trim()).filter(s => s);
          const steps = document.getElementById('rSteps').value
            .split('\n').map(s => s.trim()).filter(s => s);

          const calories = parseInt(document.getElementById('nCal').value) || 0;
          const protein = parseInt(document.getElementById('nPro').value) || 0;
          const carbs = parseInt(document.getElementById('nCarb').value) || 0;
          const fat = parseInt(document.getElementById('nFat').value) || 0;

          if (!title || !cat) {
            showErr('Please fill in the title and category.');
            return;
          }
          if (!ingredients.length || !steps.length) {
            showErr('Please provide at least one ingredient and one step.');
            return;
          }

          let imageUrl = existingImageUrl;
          if (file) {
            imageUrl = await uploadRecipeImage(file);
          }

          const payload = {
            title,
            category: cat,
            image: imageUrl,
            ingredients,
            steps,
            calories,
            protein,
            carbs,
            fat
          };

          if (isEditMode && editId) {
            const { data: updated, error } = await supabase
              .from('recipes')
              .update(payload)
              .eq('id', editId)
              .select('*')
              .maybeSingle();

            if (error) {
              console.error('[edit] update error', error);
              throw new Error(error.message);
            }

            const idToGo = updated?.id || editId;
            window.location.href = 'recipe-detail.html?id=' + encodeURIComponent(idToGo);
          } else {
            const newRecipe = await RecipeSite.addRecipe(payload);

            if (newRecipe && newRecipe.id) {
              window.location.href = 'recipe-detail.html?id=' + encodeURIComponent(newRecipe.id);
            } else {
              window.location.href = 'recipes.html#browse';
            }
          }

        } catch (err) {
          console.error(err);
          showErr('Error saving recipe: ' + (err.message || String(err)));
        }
      });

      const check = setInterval(() => {
        if (window.supabase) {
          clearInterval(check);
          initAuthAndMaybeLoad().catch(err => {
            console.error(err);
            showErr('Error initialising page: ' + (err.message || String(err)));
          });
        }
      }, 100);
    });
  </script>
</body>
</html>
