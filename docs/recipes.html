<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecipeSite — Discover</title>

  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/recipes.css" />

  <script>
    window.ENV_SUPABASE_URL = 'https://bhqeasmtrdfqncliipki.supabase.co/';
    window.ENV_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJocWVhc210cmRmcW5jbGlpcGtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNzQ4NzgsImV4cCI6MjA3NzY1MDg3OH0.249y8yGBYKgcvnoKkdTft94Mu74kbO_Ioso2HFrTFpg';
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"
          onload="
            try {
              window.supabase = window.supabase.createClient(
                window.ENV_SUPABASE_URL,
                window.ENV_SUPABASE_KEY,
                { auth:{ persistSession:true, autoRefreshToken:true } }
              );
            } catch(e) { console.error('[supabase] init error', e); }
          "></script>
  
  <script src="js/common.js"></script>

  <style>
    .site-head{position:sticky;top:0;z-index:50;backdrop-filter:saturate(120%) blur(6px);
      background:color-mix(in oklab,var(--card,#fff),transparent 15%);border-bottom:1px solid #0001}
    .site-head .wrap{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;padding-block:10px}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700;text-decoration:none;color:inherit}
    .nav{display:flex;gap:12px;flex-wrap:wrap}
    .nav a{padding:6px 10px;border-radius:999px;text-decoration:none;color:inherit;border:1px solid transparent}
    .nav a[aria-current="page"]{background:color-mix(in oklab,var(--accent,#16a34a),white 85%);border-color:#00000010}
    .head-search{flex:1;min-width:220px;max-width:480px}
    .head-search input{width:100%}
    .alert{margin:12px 0;padding:10px 12px;border:1px solid #e11;border-radius:10px;background:#fee; color:#700}
    .noimg-badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#f3f4f6;color:#64748b;font-size:.8rem}
    .browse-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:16px; align-items: center; }
    .spacer { flex: 1; }
  </style>

  <script>
  document.addEventListener('DOMContentLoaded', () => {

    function startAppLogic() {
      const alertBox = document.getElementById('alert');
      const showAlert = (msg) => { alertBox.textContent = msg; alertBox.hidden = false; };
      const hideAlert = () => { alertBox.hidden = true; alertBox.textContent = ''; };
      
      let appBooted = false;

      /* ===== AUTH / HEADER UI ===== */
      function updateAuthUI(session) {
        const authContainer = document.querySelector('header .auth');
        if (!authContainer) return;

        if (!session) {
          const next = encodeURIComponent('recipes.html' + location.search + location.hash);
          authContainer.innerHTML = `<a class="btn small outline" href="index.html?next=${next}">Sign in</a>`;
        } else {
          const user = session.user;
          const displayName = user.user_metadata?.username || user.email.split('@')[0];
          authContainer.innerHTML = `
            <span style="font-size: 0.9rem; margin-right: 12px;">Hi, ${displayName}</span>
            <button class="btn small outline" id="logoutButton">Logout</button>
          `;
          authContainer.querySelector('#logoutButton').addEventListener('click', async () => {
            await supabase.auth.signOut();
          });
        }

        if (!appBooted) {
          appBooted = true;
          bootApp();
        }
      }

      // Listen for auth changes (no redirect for guests)
      supabase.auth.onAuthStateChange((_event, session) => {
        updateAuthUI(session || null);
      });

      function bootApp() {
        const sections = [...document.querySelectorAll('section.route')];
        const tabs = [...document.querySelectorAll('header .nav a')];
        function setActive(hash){
          const route = (hash||'#browse').replace('#','');
          sections.forEach(s => s.hidden = s.dataset.route !== route);
          tabs.forEach(a => a.setAttribute('aria-current', a.getAttribute('href') === '#'+route ? 'page':'false'));
          if (route==='favourites') renderFavourites();
          if (route==='pantry')     bootPantry();
        }
        window.addEventListener('hashchange', ()=>setActive(location.hash));
        if (!location.hash) location.hash = '#browse';
        setActive(location.hash);

        /* ===== Browse + Generator ===== */
        const state = { all: [], filtered: [], page:1, pageSize:12, randomMode: false };
        
        const grid = document.getElementById('browseGrid');
        const qInput = document.getElementById('searchInput');
        const catSelect = document.getElementById('categorySelect');
        const sortSelect = document.getElementById('sortSelect');
        const prevBtn = document.getElementById('pagePrev');
        const nextBtn = document.getElementById('pageNext');
        const surpriseBtn = document.getElementById('surpriseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const globalSearch = document.getElementById('globalSearch');
        
        // --- FIXED ADD BUTTON LOGIC ---
        const addBtn = document.getElementById('addRecipeBtn');
        if (addBtn) {
          addBtn.addEventListener('click', async () => {
             // Fetch FRESH session on click
             const { data } = await supabase.auth.getSession();
             if (!data.session) {
               alert('Please sign in to add recipes.');
               window.location.href = 'index.html?next=add-recipe.html';
               return;
             }
             window.location.href = 'add-recipe.html';
          });
        }

        const debounce = (fn,ms)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
        const normalize = s => (s||'').toString().toLowerCase();

        /* Pantry-based suggestion helpers for Browse */
        let browsePantryNames = [];

        function computePantryMatches(recipe) {
          if (!browsePantryNames.length) return 0;
          const ings = (recipe.ingredients || []).map((it) =>
            normalize(it).replace(/[^a-z0-9\s]/g, '')
          );
          let count = 0;
          for (const raw of browsePantryNames) {
            const pn = raw.trim();
            if (!pn) continue;
            const cleanPn = pn.replace(/[^a-z0-9\s]/g, '');
            if (!cleanPn) continue;
            const hit = ings.some((ing) =>
              ing.includes(cleanPn) || cleanPn.includes(ing)
            );
            if (hit) count++;
          }
          return count;
        }

        async function refreshBrowsePantryMatches(recipes) {
          try {
            if (!window.RecipeSite || !RecipeSite.pantryList) {
              browsePantryNames = [];
              (recipes || []).forEach((r) => (r._pantryMatches = 0));
              return;
            }
            const maybe = RecipeSite.pantryList();
            const items = await Promise.resolve(maybe);
            browsePantryNames = (items || [])
              .map((it) => normalize(it.name || ''))
              .filter(Boolean);

            (recipes || []).forEach((r) => {
              r._pantryMatches = computePantryMatches(r);
            });
          } catch (e) {
            console.warn('[browse pantry] could not load pantry', e);
            browsePantryNames = [];
            (recipes || []).forEach((r) => (r._pantryMatches = 0));
          }
        }

        function cardHTML(r){
          const to = `recipe-detail.html?id=${encodeURIComponent(r.id)}`;
         
          return `
            <article class="card link-card">
              ${imgHtml}
              <div class="row">
                <h2 class="card-title"><a class="title-link" href="${to}">${r.title}</a></h2>
                <button class="btn small" type="button" data-fav="${r.id}">☆ Save</button>
              </div>
              <div class="pill cat">${r.category || ''}</div>
              <p class="muted">Ingredients: ${(r.ingredients||[]).slice(0,4).join(', ')}...</p>
              ${matchLine}
              <div class="row"><a class="btn small outline" href="${to}">View details</a></div>
            </article>`;
        }

        function renderGrid(items){
          if (!items.length) { grid.innerHTML = '<p class="muted">No recipes found.</p>'; return; }
          grid.innerHTML = items.map(cardHTML).join('');
          grid.querySelectorAll('[data-fav]').forEach(btn=>{
            btn.addEventListener('click', async (e)=>{
              e.preventDefault();
              const id = btn.getAttribute('data-fav');
              try {
                const isFav = await RecipeSite.toggleFav(id);
                btn.textContent = isFav ? '✓ Saved' : '☆ Save';
              } catch (e) {
                console.error('toggleFav error', e);
              }
            });
          });
        }

        /* UPDATED: applyFilters now sorts by pantry matches first */
        function applyFilters(){
          if (state.randomMode) return;

          const q = normalize(qInput.value);
          const cat = catSelect.value || 'All';
          let list = state.all;

          if (cat!=='All') {
            list = list.filter(r => (r.category||'').toLowerCase() === cat.toLowerCase());
          }

          if (q) {
            list = list.filter(r => {
              const hay = [r.title, r.category, ...(r.ingredients||[])].join(' ').toLowerCase();
              return hay.includes(q);
            });
          }
          
          const mode = sortSelect.value || 'recent';

          // clone before sorting so we don't mutate state.all order
          list = [...list];
          list.sort((a,b)=>{
            const ma = typeof a._pantryMatches === 'number' ? a._pantryMatches : 0;
            const mb = typeof b._pantryMatches === 'number' ? b._pantryMatches : 0;
            if (mb !== ma) return mb - ma;        // more pantry matches first
            if (mode === 'alpha') {
              return (a.title || '').localeCompare(b.title || '');
            }
            // 'recent' → keep original order for ties
            return 0;
          });

          state.filtered = list;
          state.page = 1;
          paginate();
        }

        function paginate(){
          if (state.randomMode) {
             renderGrid(state.filtered);
             prevBtn.disabled = true;
             nextBtn.disabled = true;
             return;
          }
          const start = (state.page-1)*state.pageSize;
          const slice = state.filtered.slice(start, start+state.pageSize);
          renderGrid(slice);
          prevBtn.disabled = state.page<=1;
          nextBtn.disabled = start + state.pageSize >= state.filtered.length;
        }

        function surpriseMe() {
          const currentPool = state.filtered.length > 0 && !state.randomMode ? state.filtered : state.all;
          if (currentPool.length === 0) return alert('No recipes available to choose from!');
          
          const shuffled = [...currentPool].sort(() => 0.5 - Math.random());
          const picks = shuffled.slice(0, 3);
          
          state.filtered = picks;
          state.randomMode = true;
          resetBtn.hidden = false;
          paginate();
        }

        async function bootBrowse(){
          try{
            hideAlert();
            const cats = await RecipeSite.listCategories();
            catSelect.innerHTML = '<option>All</option>' + (cats||[]).map(c=>`<option>${c}</option>`).join('');
            catSelect.value = 'All';

            const all = await RecipeSite.listRecipes();
            state.all = all || [];
            state.filtered = all || [];

            await refreshBrowsePantryMatches(state.all);

            qInput.addEventListener('input', debounce(applyFilters,150));
            catSelect.addEventListener('change', applyFilters);
            sortSelect.addEventListener('change', applyFilters);
            
            prevBtn.addEventListener('click', ()=>{state.page--; paginate();});
            nextBtn.addEventListener('click', ()=>{state.page++; paginate();});
            
            globalSearch.addEventListener('input', debounce(()=>{
              qInput.value = globalSearch.value;
              if (location.hash!=='#browse') location.hash='#browse';
              state.randomMode = false; resetBtn.hidden = true;
              applyFilters();
            },150));

            surpriseBtn.addEventListener('click', surpriseMe);
            resetBtn.addEventListener('click', () => {
               state.randomMode = false;
               resetBtn.hidden = true;
               qInput.value = '';
               applyFilters();
            });

            applyFilters();
          }catch(err){
            console.error(err);
            // Don't block UI if just loading fails
            grid.innerHTML = '<p class="muted">Error loading recipes. Check console.</p>';
          }
        }
        bootBrowse();

        /* ===== Pantry ===== */
        let pantryBooted=false;
        function bootPantry(){
          if (pantryBooted) return; pantryBooted=true;
          const listEl=document.getElementById('pantryList');
          const nameEl=document.getElementById('pantryName');
          const qtyEl=document.getElementById('pantryQty');
          const expEl=document.getElementById('pantryExpiry');
          const addBtn=document.getElementById('addPantryBtn');
          let editIndex=null;

          function render(){
            const items=RecipeSite.pantryList();
            listEl.innerHTML='';
            if(!items.length){ listEl.innerHTML='<p class="muted">Your pantry is empty.</p>'; return; }
            items.forEach((it,idx)=>{
              const card=document.createElement('article'); card.className='card';
              card.innerHTML=`
                <div class="row">
                  <h3 style="margin:0">${it.name}</h3>
                  <div class="row" style="gap:6px;margin-left:auto">
                    <button class="btn small outline" data-edit="${idx}">Edit</button>
                    <button class="btn small outline" data-del="${idx}">Remove</button>
                  </div>
                </div>
                <p>Quantity: ${it.quantity}</p>
                <p>Expiry: ${it.expiry || 'N/A'}</p>`;
              card.querySelector('[data-del]').onclick=()=>{
                const items=RecipeSite.pantryList(); items.splice(idx,1);
                localStorage.setItem('pantry', JSON.stringify(items)); render(); reset();
              };
              card.querySelector('[data-edit]').onclick=()=>{
                nameEl.value=it.name; qtyEl.value=it.quantity; expEl.value=it.expiry||'';
                editIndex=idx; addBtn.textContent='Save Changes';
              };
              listEl.appendChild(card);
            });
          }
          function reset(){ nameEl.value=''; qtyEl.value=''; expEl.value=''; editIndex=null; addBtn.textContent='Add Ingredient'; }
          addBtn.addEventListener('click', ()=>{
            const name=nameEl.value.trim(), quantity=qtyEl.value.trim(), expiry=expEl.value;
            if(!name||!quantity){ alert('Please enter ingredient name and quantity.'); return; }
            const items=RecipeSite.pantryList();
            if(editIndex!==null) items[editIndex]={name,quantity,expiry}; else items.push({name,quantity,expiry});
            localStorage.setItem('pantry', JSON.stringify(items)); render(); reset();
          });
          render();
        }

        /* ===== Favourites ===== */
        async function renderFavourites(){
          const grid=document.getElementById('favGrid'); grid.innerHTML='<p class="muted">Loading…</p>';
          try{
            const ids=[...RecipeSite.getFavSet()];
            const all=await RecipeSite.listRecipes();
            const favs=all.filter(r=>ids.includes(r.id));
            if(!favs.length){ grid.innerHTML='<p class="muted">No favourites yet.</p>'; return; }
            grid.innerHTML=favs.map(cardHTML).join('');
            grid.querySelectorAll('[data-unfav],[data-fav]').forEach(btn=>{
              const id = btn.getAttribute('data-unfav') || btn.getAttribute('data-fav');
              btn.addEventListener('click', async ()=>{
                await RecipeSite.toggleFav(id);
                btn.closest('.card').remove();
                if(!grid.children.length) grid.innerHTML='<p class="muted">No favourites.</p>';
              });
            });
          }catch(e){ console.error(e); grid.innerHTML=''; }
        }
      } 
    } 

    const checkSupabase = setInterval(() => {
      if (window.supabase) {
        clearInterval(checkSupabase);
        startAppLogic();
      }
    }, 100);
    
  });
  </script>
</head>
<body>
  <header class="site-head">
    <div class="container wrap">
      <a href="recipes.html#browse" class="brand">
        <svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;" aria-hidden="true">
          <path d="M8 3a1 1 0 0 0-1 1v2h10a1 1 0 1 1 0 2H7v2h8.5a3.5 3.5 0 1 1 0 7H12v2h4.5a5.5 5.5 0 0 0 0-11H6V4a1 1 0 0 1 1-1h1z"/>
        </svg>
        <span>RecipeSite</span>
      </a>

      <nav class="nav">
        <a href="#browse" aria-current="page">Browse</a>
        <a href="#pantry">Pantry</a>
        <a href="#favourites">Favourites</a>
      </nav>

      <div class="head-search">
        <input id="globalSearch" type="search" placeholder="Search all recipes..." />
      </div>
      
      <div class="auth" style="min-width: 120px; text-align: right;"></div>
    </div>
  </header>

  <main class="container" style="padding-top: 24px; padding-bottom: 24px;">
    <div id="alert" class="alert" hidden></div>

    <section class="route" data-route="browse">
      <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <h1>Discover Recipes</h1>
        <button id="addRecipeBtn" class="btn">＋ Add Recipe</button>
      </div>
      
      <div class="filters card" style="margin-bottom: 24px;">
        <div class="row" style="gap: 16px; flex-wrap:wrap;">
            <label class="field" style="flex: 1 1 200px;">
              <span>Search</span>
              <input id="searchInput" type="search" placeholder="e.g. Chicken" />
            </label>
            <label class="field" style="flex: 1 1 150px;">
              <span>Category</span>
              <select id="categorySelect"><option>Loading...</option></select>
            </label>
            <label class="field" style="flex: 1 1 150px;">
              <span>Sort</span>
              <select id="sortSelect">
                <option value="recent">Recent</option>
                <option value="alpha">A-Z</option>
              </select>
            </label>
        </div>
        
        <div class="browse-actions">
          <button id="surpriseBtn" class="btn outline">✨ Surprise Me</button>
          <button id="resetBtn" class="btn outline" hidden>Show All</button>
          <div class="spacer"></div>
          <span class="small muted">Showing random suggestions based on your filters</span>
        </div>
      </div>

      <div id="browseGrid" class="recipe-grid">
        <p class="muted">Loading recipes...</p>
      </div>

      <nav class="pagination" style="display: flex; justify-content: center; gap: 12px; margin-top: 24px;">
        <button id="pagePrev" class="btn outline" disabled>← Previous</button>
        <button id="pageNext" class="btn outline" disabled>Next →</button>
      </nav>
    </section>

    <section class="route" data-route="pantry" hidden>
      <h1>My Pantry</h1>
      <div class="pantry-layout" style="display: grid; grid-template-columns: 300px 1fr; gap: 24px;">
        <aside class="card">
          <h3>Add to Pantry</h3>
          <form id="pantryForm">
            <label class="field"><span>Name</span><input id="pantryName" type="text" required /></label>
            <label class="field"><span>Quantity</span><input id="pantryQty" type="text" required /></label>
            <label class="field"><span>Expiry</span><input id="pantryExpiry" type="date" /></label>
            <button id="addPantryBtn" class="btn full" type="button">Add Ingredient</button>
          </form>
        </aside>
        <div id="pantryList" style="display: flex; flex-direction: column; gap: 16px;">
          <p class="muted">Your pantry is empty.</p>
        </div>
      </div>
    </section>

    <section class="route" data-route="favourites" hidden>
      <h1>My Favourites</h1>
      <div id="favGrid" class="recipe-grid">
        <p class="muted">Loading favourites...</p>
      </div>
    </section>
  </main>
</body>
</html>