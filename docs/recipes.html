<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecipeSite ‚Äî Discover & Cook</title>
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/recipes.css" />
  <script defer src="js/common.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="container header-row">
      <a class="brand" href="recipes.html#browse" aria-label="RecipeSite Home">
        <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M8 3a1 1 0 0 0-1 1v2h10a1 1 0 1 1 0 2H7v2h8.5a3.5 3.5 0 1 1 0 7H12v2h4.5a5.5 5.5 0 0 0 0-11H6V4a1 1 0 0 1 1-1h1z"/>
        </svg>
        <span>RecipeSite</span>
      </a>

      <nav class="main-nav" aria-label="Primary">
        <a href="#browse" class="active">Discover</a>
        <!-- Collections removed -->
        <a href="#cook">Cook</a>
      </nav>

      <div class="header-actions">
        <button id="themeToggle" class="pill" title="Toggle theme" aria-pressed="false">üåô</button>
        <form class="search" role="search" onsubmit="return false">
          <input id="globalSearch" placeholder="Search recipes‚Ä¶" />
          <button id="globalSearchBtn" title="Search">üîç</button>
        </form>
        <span class="pill" id="userBadge" hidden></span>
        <a class="btn small" id="loginLink" href="index.html?next=recipes.html#browse">Login</a>
        <button class="menu-toggle" aria-label="Menu">‚ò∞</button>
      </div>
    </div>
  </header>

  <main class="container" id="app">
    <!-- Discover -->
    <section class="route" data-route="browse">
      <div class="card grid three-wide">
        <label class="field"><span>Search</span>
          <input id="q" placeholder="Search by title or ingredient" />
        </label>
        <label class="field"><span>Category</span>
          <select id="cat"></select>
        </label>
        <label class="field"><span>Sort</span>
          <select id="sort">
            <option value="pop">Popularity</option>
            <option value="title">Title A‚ÄìZ</option>
            <option value="cal_asc">Calories (low ‚Üí high)</option>
            <option value="cal_desc">Calories (high ‚Üí low)</option>
          </select>
        </label>
      </div>

      <div class="row" id="quickFilters" style="margin:8px 0 4px">
        <button class="pill filter" data-f="all">All</button>
        <button class="pill filter" data-f="vegan">Vegan</button>
        <button class="pill filter" data-f="lowcal">‚â§400 kcal</button>
        <button class="pill filter" data-f="dinner">Dinner</button>
        <button class="pill filter" data-f="breakfast">Breakfast</button>
      </div>

      <p id="resultMeta" class="muted" style="margin:6px 0 10px"></p>

      <div class="grid three" id="browseGrid" aria-live="polite"></div>
      <div class="row pager" id="pager" hidden>
        <button class="btn small outline" id="prevPage" disabled>Prev</button>
        <span id="pageInfo" class="muted"></span>
        <button class="btn small outline" id="nextPage">Next</button>
      </div>
    </section>

    <!-- Cook (Generator only) -->
    <section class="route" data-route="cook" hidden>
      <div class="card">
        <h1>Cook</h1>
        <div class="grid two">
          <label class="field"><span>Category</span>
            <select id="genCategory"></select>
          </label>
          <label class="field"><span>Key ingredient (optional)</span>
            <input id="genIngredient" placeholder="e.g. chicken, tofu, tomato" />
          </label>
        </div>
        <div class="row">
          <button class="btn" id="generateBtn">Generate</button>
          <button class="btn outline" id="surpriseBtn">Surprise Me</button>
        </div>
      </div>
      <div class="card" id="generated"></div>
    </section>
  </main>

  <script>
    // --- Theme toggle ---
    (function theme(){
      const btn = document.getElementById('themeToggle');
      const saved = localStorage.getItem('theme');
      if (saved) document.documentElement.dataset.theme = saved;
      const setIcon = () => {
        const dark = document.documentElement.dataset.theme==='dark';
        btn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
        btn.setAttribute('aria-pressed', String(dark));
      };
      setIcon();
      btn.addEventListener('click', ()=>{
        const next = (document.documentElement.dataset.theme==='dark') ? 'light' : 'dark';
        document.documentElement.dataset.theme = next;
        localStorage.setItem('theme', next);
        setIcon();
      });
    })();

    // --- Router ---
    const routes = [...document.querySelectorAll('.route')];
    function showRoute(){
      const hash = (location.hash || '#browse').slice(1);
      routes.forEach(s => s.hidden = s.dataset.route !== hash);
      document.querySelectorAll('.main-nav a').forEach(a => {
        a.classList.toggle('active', a.getAttribute('href') === '#'+hash);
      });
      if (hash==='browse') renderBrowse(true);
      if (hash==='cook') initGenerator();
    }
    addEventListener('hashchange', showRoute);

    // --- Auth UI ---
    function updateUserUI(){
      const badge = document.getElementById('userBadge');
      const link  = document.getElementById('loginLink');
      const u = RecipeSite.getUser();
      if (u){
        badge.hidden = false; badge.textContent = `üë§ ${u.name}`;
        link.textContent='Logout'; link.href='#';
        link.onclick=(e)=>{ e.preventDefault(); RecipeSite.logout(); updateUserUI(); renderBrowse(); };
      } else {
        badge.hidden = true;
        link.textContent='Login';
        link.href = 'index.html?next=' + encodeURIComponent('recipes.html'+(location.hash||'#browse'));
        link.onclick=null;
      }
    }

    // --- Discover (search, sort, pagination) ---
    const q = document.getElementById('q');
    const cat = document.getElementById('cat');
    const sortSel = document.getElementById('sort');
    const browseGrid = document.getElementById('browseGrid');
    const meta = document.getElementById('resultMeta');

    const pager = document.getElementById('pager');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    let page = 1, pageSize = 9, lastResults = [];

    function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms);} }

    function initBrowse(){
      if (cat.options.length) return;
      RecipeSite.listCategories().forEach(c=>{
        const o = document.createElement('option'); o.value=c; o.textContent=c; cat.appendChild(o);
      });
      const fav = document.createElement('option');
      fav.value='Favourites'; fav.textContent='Favourites ‚òÖ'; cat.appendChild(fav);

      cat.value='All'; sortSel.value='pop';
      window.__quickFilter='all';
      q.addEventListener('input', debounce(()=>renderBrowse(), 250));
      cat.addEventListener('change', ()=>{ page=1; renderBrowse(); });
      sortSel.addEventListener('change', ()=>{ page=1; renderBrowse(); });

      document.querySelectorAll('#quickFilters .filter').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const m = btn.dataset.f;
          if (m==='dinner' || m==='breakfast') cat.value = (m==='dinner')?'Dinner':'Breakfast';
          else cat.value = 'All';
          window.__quickFilter = m;
          page=1; renderBrowse();
        });
      });

      prevBtn.onclick = ()=>{ if(page>1){ page--; renderBrowse(false); } };
      nextBtn.onclick = ()=>{
        const max = Math.max(1, Math.ceil(lastResults.length/pageSize));
        if(page<max){ page++; renderBrowse(false); }
      };

      document.addEventListener('keydown', e=>{ if(e.key==='/' && document.activeElement.tagName!=='INPUT'){ e.preventDefault(); q.focus(); } });
    }

    function sortResults(arr){
      const v = sortSel.value;
      if (v==='title') return arr.slice().sort((a,b)=>a.title.localeCompare(b.title));
      if (v==='cal_asc') return arr.slice().sort((a,b)=>a.nutrition.calories-b.nutrition.calories);
      if (v==='cal_desc') return arr.slice().sort((a,b)=>b.nutrition.calories-a.nutrition.calories);
      return arr;
    }

    function renderBrowse(reset=false){
      initBrowse();
      const query = (q.value||'').toLowerCase().trim();
      const category = cat.value;
      const favSet = RecipeSite.getFavSet();
      const mode = window.__quickFilter || 'all';

      const filtered = RecipeSite.listRecipes().filter(r=>{
        const mq = !query || r.title.toLowerCase().includes(query) || r.ingredients.some(i=>i.toLowerCase().includes(query));
        const mc = (category==='All') || (category==='Favourites' && favSet.has(r.id)) || (category!=='Favourites' && r.category===category);
        const mf = (mode==='all') ? true
                : (mode==='vegan') ? (r.category==='Vegan')
                : (mode==='lowcal') ? (r.nutrition.calories<=400)
                : (mode==='dinner') ? (r.category==='Dinner')
                : (mode==='breakfast') ? (r.category==='Breakfast')
                : true;
        return mq && mc && mf;
      });

      lastResults = sortResults(filtered);
      if (reset) page = 1;

      const total = lastResults.length;
      meta.textContent = total ? `${total} result${total===1?'':'s'}` : 'No results ‚Äî adjust your search or filters';

      browseGrid.innerHTML='';
      if (!total){
        const el = document.createElement('div');
        el.className='card';
        el.innerHTML = `<h2>No results</h2><p class="muted">Your search/filters hide everything.</p>
          <button class="btn outline" id="resetFiltersBtn">Reset filters</button>`;
        browseGrid.appendChild(el);
        el.querySelector('#resetFiltersBtn').onclick = ()=>{ q.value=''; cat.value='All'; sortSel.value='pop'; window.__quickFilter='all'; page=1; renderBrowse(); };
        pager.hidden = true;
        return;
      }

      const max = Math.max(1, Math.ceil(total/pageSize));
      page = Math.min(page, max);
      const slice = lastResults.slice((page-1)*pageSize, page*pageSize);
      slice.forEach(r=> browseGrid.appendChild(cardNode(r)));
      syncFavButtons(browseGrid);

      pager.hidden = max===1;
      prevBtn.disabled = page<=1;
      nextBtn.disabled = page>=max;
      pageInfo.textContent = `Page ${page} of ${max}`;
    }

    function cardNode(r){
      const to = `recipe-detail.html?id=${encodeURIComponent(r.id)}`;
      const wrap = document.createElement('article');
      wrap.className='card link-card';
      wrap.innerHTML=`
        <a class="thumb-link" href="${to}">
          <img class="thumb" src="${r.image}" alt="${r.title}" loading="lazy" />
        </a>
        <div class="row">
          <h2 class="card-title"><a class="title-link" href="${to}">${r.title}</a></h2>
          <button class="btn small" data-fav="${r.id}" type="button" aria-pressed="false">‚òÜ Save</button>
        </div>
        <div class="pill cat">${r.category}</div>
        <p class="muted">Ingredients: ${r.ingredients.slice(0,4).join(', ')}...</p>
        <div class="row"><a class="btn small outline" href="${to}">View details</a></div>
      `;
      wrap.querySelector('[data-fav]').addEventListener('click',(e)=>{
        e.stopPropagation(); RecipeSite.toggleFav(r.id); syncFavButtons(wrap);
      });
      wrap.addEventListener('click',(e)=>{
        const isButton = e.target.closest('button,[data-fav]');
        const isLink   = e.target.closest('a[href]');
        if (!isButton && !isLink) location.href = to;
      });
      return wrap;
    }

    function syncFavButtons(scope=document){
      const set = RecipeSite.getFavSet();
      scope.querySelectorAll('[data-fav]').forEach(btn=>{
        const on = set.has(btn.getAttribute('data-fav'));
        btn.textContent = on ? '‚òÖ Saved' : '‚òÜ Save';
        btn.setAttribute('aria-pressed', on);
        btn.classList.toggle('saved', on);
      });
    }

    // --- Header search ---
    (function headerSearch(){
      const gs=document.getElementById('globalSearch'), gsBtn=document.getElementById('globalSearchBtn');
      function runGS(){
        const qv=(gs.value||'').trim(); location.hash='#browse';
        setTimeout(()=>{ const i=document.getElementById('q'); if(i){ i.value=qv; i.dispatchEvent(new Event('input')); }},0);
      }
      gsBtn.addEventListener('click', runGS);
      gs.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); runGS(); } });
      const toggle=document.querySelector('.menu-toggle'), nav=document.querySelector('.main-nav');
      toggle.addEventListener('click', ()=> nav.classList.toggle('open'));
    })();

    // --- COOK PAGE: generator logic (fixed) ---
    let genInit=false;
    function initGenerator(){
      if (genInit) return;
      const catSel = document.getElementById('genCategory');
      const keyInp = document.getElementById('genIngredient');
      const out    = document.getElementById('generated');
      const genBtn = document.getElementById('generateBtn');
      const surpriseBtn = document.getElementById('surpriseBtn');

      // Populate categories (include All)
      RecipeSite.listCategories().forEach(c=>{
        const o=document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o);
      });
      catSel.value='All';

      function pool(){
        const cat=catSel.value;
        const key=(keyInp.value||'').toLowerCase().trim();
        return RecipeSite.listRecipes().filter(r=>{
          const mc = (cat==='All') || r.category===cat;
          const mk = !key || r.title.toLowerCase().includes(key) || r.ingredients.some(i=>i.toLowerCase().includes(key));
          return mc && mk;
        });
      }

      function render(r){
        out.innerHTML='';
        if(!r){
          out.innerHTML='<p class="muted">No match. Try a different category or ingredient.</p>';
          return;
        }
        out.appendChild(cardNode(r));
        syncFavButtons(out);
        // scroll to result on mobile
        out.scrollIntoView({behavior:'smooth', block:'start'});
      }

      genBtn.addEventListener('click', ()=>{
        const p = pool();
        render(p.length ? p[Math.floor(Math.random()*p.length)] : null);
      });
      surpriseBtn.addEventListener('click', ()=>{
        const all = RecipeSite.listRecipes();
        render(all[Math.floor(Math.random()*all.length)]);
      });

      genInit=true;
    }

    // boot
    if (!location.hash) location.hash='#browse';
    updateUserUI(); showRoute();
  </script>
</body>
</html>
