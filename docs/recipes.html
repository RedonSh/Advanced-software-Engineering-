<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecipeSite ‚Äî Discover & Cook</title>
  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/recipes.css" />

  <!-- Provide your Supabase env values here (no leading spaces!) -->
  <script>
    window.ENV_SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co';
    window.ENV_SUPABASE_KEY = 'YOUR-ANON-PUBLIC-KEY';
  </script>
  <script defer src="supabaseClient.js"></script>
  <script defer src="js/common.js"></script>
</head>
<body>
  <header class="site-header">
    <div class="container header-row">
      <a class="brand" href="recipes.html#browse" aria-label="RecipeSite Home">RecipeSite</a>
      <div class="nav">
        <nav class="main-nav" aria-label="Primary">
          <a href="#browse" id="tab-browse" class="active">Browse</a>
          <a href="#generator" id="tab-generator">Generator</a>
          <a href="#pantry" id="tab-pantry">Pantry</a>
          <a href="#favourites" id="tab-favourites">Favourites</a>
        </nav>
      </div>
      <div class="header-actions">
        <form class="search" role="search" onsubmit="return false">
          <input id="globalSearch" placeholder="Search recipes‚Ä¶" />
          <button id="globalSearchBtn" title="Search">üîç</button>
        </form>
        <span class="pill" id="userBadge" hidden></span>
        <a class="btn small" id="loginLink" href="index.html?next=recipes.html#browse">Login</a>
      </div>
    </div>
  </header>

  <main class="container" id="app">
    <!-- BROWSE -->
    <section class="route" data-route="browse">
      <div class="card grid three-wide">
        <label class="field"><span>Search</span>
          <input id="q" placeholder="Search by title or ingredient" />
        </label>
        <label class="field"><span>Category</span>
          <select id="cat"></select>
        </label>
        <label class="field"><span>Sort</span>
          <select id="sort">
            <option value="pop">Popularity</option>
            <option value="title">Title A‚ÄìZ</option>
            <option value="cal_asc">Calories (low ‚Üí high)</option>
            <option value="cal_desc">Calories (high ‚Üí low)</option>
          </select>
        </label>
      </div>

      <div class="row" id="quickFilters" style="margin:8px 0 4px">
        <button class="pill filter" data-f="all">All</button>
        <button class="pill filter" data-f="vegan">Vegan</button>
        <button class="pill filter" data-f="lowcal">‚â§400 kcal</button>
        <button class="pill filter" data-f="dinner">Dinner</button>
        <button class="pill filter" data-f="breakfast">Breakfast</button>
      </div>

      <p id="resultMeta" class="muted" style="margin:6px 0 10px"></p>
      <div class="grid three" id="browseGrid" aria-live="polite"></div>
      <div class="row pager" id="pager" hidden>
        <button class="btn small outline" id="prevPage" disabled>Prev</button>
        <span id="pageInfo" class="muted"></span>
        <button class="btn small outline" id="nextPage">Next</button>
      </div>
    </section>

    <!-- GENERATOR -->
    <section class="route" data-route="generator" hidden>
      <div class="card">
        <h1>Recipe Generator</h1>
        <div class="grid two">
          <label class="field"><span>Category</span>
            <select id="genCategory"></select>
          </label>
          <label class="field"><span>Key ingredient (optional)</span>
            <input id="genIngredient" placeholder="e.g. chicken, tofu, tomato" />
          </label>
        </div>
        <div class="row">
          <button class="btn" id="generateBtn">Generate</button>
          <button class="btn outline" id="surpriseBtn">Surprise Me</button>
        </div>
      </div>
      <div class="card" id="generated"></div>
    </section>

    <!-- PANTRY -->
    <section class="route" data-route="pantry" hidden>
      <h1>My Pantry</h1>
      <div class="card">
        <h2>Available Ingredients</h2>
        <div id="pantryList"></div>
      </div>
      <div class="card">
        <h2>Add Ingredient</h2>
        <div class="grid two">
          <label class="field"><span>Ingredient</span>
            <input id="pantryName" placeholder="e.g. Tomato" />
          </label>
          <label class="field"><span>Quantity</span>
            <input id="pantryQty" type="text" placeholder="e.g. 3 pcs, 500g" />
          </label>
          <label class="field"><span>Expiry Date</span>
            <input id="pantryExpiry" type="date" />
          </label>
        </div>
        <div class="row">
          <button class="btn" id="addPantryBtn">Add Ingredient</button>
        </div>
      </div>
    </section>

    <!-- FAVOURITES + UPLOAD -->
    <section class="route" data-route="favourites" hidden>
      <div class="row" style="justify-content:space-between;align-items:center">
        <h1>Your Favourites</h1>
        <div class="row">
          <button class="btn outline" id="refreshFavsBtn">Refresh</button>
          <button class="btn" id="logoutBtn">Logout</button>
        </div>
      </div>

      <div class="card" id="uploadSection">
        <h2>Add Your Own Recipe</h2>
        <div class="grid two">
          <label class="field"><span>Title</span>
            <input id="myTitle" placeholder="Recipe title" />
          </label>
          <label class="field"><span>Category</span>
            <input id="myCategory" placeholder="e.g. Breakfast, Dinner" />
          </label>
        </div>
        <label class="field"><span>Ingredients (comma-separated)</span>
          <input id="myIngredients" placeholder="e.g. egg, flour, milk" />
        </label>
        <label class="field"><span>Image URL</span>
          <input id="myImage" placeholder="Paste an image link" />
        </label>
        <div class="row">
          <button class="btn" id="myAddRecipeBtn">Add Recipe</button>
        </div>
      </div>

      <div class="grid three" id="favGrid"></div>
    </section>
  </main>

  <script>
    // ---------- Auth UI ----------
    function updateUserUI(){
      const badge = document.getElementById('userBadge');
      const link  = document.getElementById('loginLink');
      const u = RecipeSite.getUser();
      if (u){
        badge.hidden = false; badge.textContent = `üë§ ${u.name}`;
        link.textContent='Logout'; link.href='#';
        link.onclick=(e)=>{ e.preventDefault(); RecipeSite.logout(); updateUserUI(); if(location.hash==='#favourites') renderFavourites(); };
      } else {
        badge.hidden = true;
        link.textContent='Login';
        link.href = 'index.html?next=' + encodeURIComponent('recipes.html'+(location.hash||'#browse'));
        link.onclick=null;
      }
    }

    // ---------- Router ----------
    const routes = [...document.querySelectorAll('.route')];
    async function showRoute(){
      const hash = (location.hash || '#browse').slice(1);
      routes.forEach(s => s.hidden = s.dataset.route !== hash);
      document.querySelectorAll('.main-nav a').forEach(a => a.classList.toggle('active', a.getAttribute('href') === '#'+hash));

      if (hash==='browse') await renderBrowse(true);
      if (hash==='generator') initGenerator();
      if (hash==='favourites') renderFavourites();
      if (hash==='pantry') initPantry();
    }
    addEventListener('hashchange', showRoute);

    // ---------- Browse ----------
    const q = document.getElementById('q');
    const cat = document.getElementById('cat');
    const sortSel = document.getElementById('sort');
    const browseGrid = document.getElementById('browseGrid');
    const meta = document.getElementById('resultMeta');

    const pager = document.getElementById('pager');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');
    let page = 1, pageSize = 9, lastResults = [];
    let browseInitDone = false;

    function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms);} }

    async function initBrowse(){
      if (browseInitDone) return;
      const cats = await RecipeSite.listCategories();
      cats.forEach(c=>{
        const o = document.createElement('option'); o.value=c; o.textContent=c; cat.appendChild(o);
      });
      const fav = document.createElement('option');
      fav.value='Favourites'; fav.textContent='Favourites ‚òÖ'; cat.appendChild(fav);

      cat.value='All'; sortSel.value='pop';
      window.__quickFilter='all';
      q.addEventListener('input', debounce(()=>renderBrowse(), 250));
      cat.addEventListener('change', ()=>{ page=1; renderBrowse(); });
      sortSel.addEventListener('change', ()=>{ page=1; renderBrowse(); });

      document.querySelectorAll('#quickFilters .filter').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const m = btn.dataset.f;
          if (m==='dinner' || m==='breakfast') cat.value = (m==='dinner')?'Dinner':'Breakfast';
          else cat.value = 'All';
          window.__quickFilter = m;
          page=1; renderBrowse();
        });
      });

      prevBtn.onclick = ()=>{ if(page>1){ page--; renderBrowse(false); } };
      nextBtn.onclick = ()=>{ const max = Math.max(1, Math.ceil(lastResults.length/pageSize)); if(page<max){ page++; renderBrowse(false); } };

      const gs=document.getElementById('globalSearch'), gsBtn=document.getElementById('globalSearchBtn');
      function runGS(){
        const qv=(gs.value||'').trim(); location.hash='#browse';
        setTimeout(()=>{ const i=document.getElementById('q'); if(i){ i.value=qv; i.dispatchEvent(new Event('input')); }},0);
      }
      gsBtn.addEventListener('click', runGS);
      gs.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); runGS(); } });

      browseInitDone = true;
    }

    function sortResults(arr){
      const v = sortSel.value;
      if (v==='title') return arr.slice().sort((a,b)=>a.title.localeCompare(b.title));
      if (v==='cal_asc') return arr.slice().sort((a,b)=>(a.nutrition?.calories||0)-(b.nutrition?.calories||0));
      if (v==='cal_desc') return arr.slice().sort((a,b)=>(b.nutrition?.calories||0)-(a.nutrition?.calories||0));
      return arr;
    }

    async function renderBrowse(reset=false){
      await initBrowse();

      const query = (q.value||'').toLowerCase().trim();
      const category = cat.value;
      const favSet = RecipeSite.getFavSet();
      const mode = window.__quickFilter || 'all';

      const all = await RecipeSite.listRecipes();
      const filtered = all.filter(r=>{
        const mq = !query || r.title.toLowerCase().includes(query) || r.ingredients.some(i=>i.toLowerCase().includes(query));
        const mc = (category==='All') || (category==='Favourites' && favSet.has(r.id)) || (category!=='Favourites' && r.category===category);
        const mf = (mode==='all') ? true
                : (mode==='vegan') ? (r.category==='Vegan')
                : (mode==='lowcal') ? ((r.nutrition?.calories||0)<=400)
                : (mode==='dinner') ? (r.category==='Dinner')
                : (mode==='breakfast') ? (r.category==='Breakfast')
                : true;
        return mq && mc && mf;
      });

      lastResults = sortResults(filtered);
      if (reset) page = 1;

      const total = lastResults.length;
      meta.textContent = total ? `${total} result${total===1?'':'s'}` : 'No results ‚Äî adjust your search or filters';

      browseGrid.innerHTML='';
      if (!total){
        const el = document.createElement('div');
        el.className='card';
        el.innerHTML = `<h2>No results</h2><p class="muted">Your search/filters hide everything.</p>
          <button class="btn outline" id="resetFiltersBtn">Reset filters</button>`;
        browseGrid.appendChild(el);
        el.querySelector('#resetFiltersBtn').onclick = ()=>{ q.value=''; cat.value='All'; sortSel.value='pop'; window.__quickFilter='all'; page=1; renderBrowse(); };
        pager.hidden = true;
        return;
      }

      const max = Math.max(1, Math.ceil(total/pageSize));
      page = Math.min(page, max);
      const slice = lastResults.slice((page-1)*pageSize, page*pageSize);
      slice.forEach(r=> browseGrid.appendChild(cardNode(r)));
      syncFavButtons(browseGrid);

      pager.hidden = max===1;
      prevBtn.disabled = page<=1;
      nextBtn.disabled = page>=max;
      pageInfo.textContent = `Page ${page} of ${max}`;
    }

    function cardNode(r){
      const to = `recipe-detail.html?id=${encodeURIComponent(r.id)}`;
      const wrap = document.createElement('article');
      wrap.className='card link-card';
      wrap.innerHTML=`
        <a class="thumb-link" href="${to}">
          <img class="thumb" src="${r.image}" alt="${r.title}" loading="lazy" />
        </a>
        <div class="row">
          <h2 class="card-title"><a class="title-link" href="${to}">${r.title}</a></h2>
          <button class="btn small" data-fav="${r.id}" type="button" aria-pressed="false">‚òÜ Save</button>
        </div>
        <div class="pill cat">${r.category}</div>
        <p class="muted">Ingredients: ${r.ingredients.slice(0,4).join(', ')}...</p>
        <div class="row"><a class="btn small outline" href="${to}">View details</a></div>
      `;
      wrap.querySelector('[data-fav]').addEventListener('click',(e)=>{
        e.stopPropagation(); RecipeSite.toggleFav(r.id); syncFavButtons(wrap);
      });
      wrap.addEventListener('click',(e)=>{
        const isButton = e.target.closest('button,[data-fav]');
        const isLink   = e.target.closest('a[href]');
        if (!isButton && !isLink) location.href = to;
      });
      return wrap;
    }

    function syncFavButtons(scope=document){
      const set = RecipeSite.getFavSet();
      scope.querySelectorAll('[data-fav]').forEach(btn=>{
        const on = set.has(btn.getAttribute('data-fav'));
        btn.textContent = on ? '‚òÖ Saved' : '‚òÜ Save';
        btn.setAttribute('aria-pressed', on);
        btn.classList.toggle('saved', on);
      });
    }

    // ---------- Generator ----------
    let genInit=false;
    function initGenerator(){
      if (genInit) return;
      const catSel = document.getElementById('genCategory');
      const keyInp = document.getElementById('genIngredient');
      const out    = document.getElementById('generated');
      const genBtn = document.getElementById('generateBtn');
      const surpriseBtn = document.getElementById('surpriseBtn');

      RecipeSite.listCategories().then(cats=>{
        cats.forEach(c=>{
          const o=document.createElement('option'); o.value=c; o.textContent=c; catSel.appendChild(o);
        });
        catSel.value='All';
      });

      async function pool(){
        const cat=catSel.value;
        const key=(keyInp.value||'').toLowerCase().trim();
        const list = await RecipeSite.listRecipes();
        return list.filter(r=>{
          const mc = (cat==='All') || r.category===cat;
          const mk = !key || r.title.toLowerCase().includes(key) || r.ingredients.some(i=>i.toLowerCase().includes(key));
          return mc && mk;
        });
      }
      function render(r){
        out.innerHTML='';
        if(!r){ out.innerHTML='<p class="muted">No match. Try a different category or ingredient.</p>'; return; }
        out.appendChild(cardNode(r));
        syncFavButtons(out);
        out.scrollIntoView({behavior:'smooth', block:'start'});
      }
      genBtn.addEventListener('click', async ()=>{ const p=await pool(); render(p.length ? p[Math.floor(Math.random()*p.length)] : null); });
      surpriseBtn.addEventListener('click', async ()=>{ const all=await RecipeSite.listRecipes(); render(all[Math.floor(Math.random()*all.length)]); });

      genInit=true;
    }

    // ---------- Pantry (local storage for now) ----------
    const pantryList = document.getElementById('pantryList');
    const addPantryBtn = document.getElementById('addPantryBtn');
    let editIndex = null;

    function renderPantry(){
      const pantry = JSON.parse(localStorage.getItem('pantry') || '[]');
      pantryList.innerHTML = '';
      if (!pantry.length){ pantryList.innerHTML = '<p class="muted">Your pantry is empty.</p>'; return; }
      pantry.forEach((item, idx) => {
        const card = document.createElement('article');
        card.className = 'card';
        card.innerHTML = `
          <div class="row">
            <h3>${item.name}</h3>
            <button class="btn small outline" data-edit="${idx}">Edit</button>
            <button class="btn small outline" data-del="${idx}">Remove</button>
          </div>
          <p>Quantity: ${item.quantity}</p>
          <p>Expiry: ${item.expiry || 'N/A'}</p>
        `;
        card.querySelector('[data-del]').onclick = () => {
          pantry.splice(idx, 1);
          localStorage.setItem('pantry', JSON.stringify(pantry));
          renderPantry(); editIndex=null; resetPantryForm();
        };
        card.querySelector('[data-edit]').onclick = () => {
          document.getElementById('pantryName').value = item.name;
          document.getElementById('pantryQty').value = item.quantity;
          document.getElementById('pantryExpiry').value = item.expiry || '';
          editIndex = idx;
          addPantryBtn.textContent = 'Save Changes';
        };
        pantryList.appendChild(card);
      });
    }
    function resetPantryForm(){ document.getElementById('pantryName').value=''; document.getElementById('pantryQty').value=''; document.getElementById('pantryExpiry').value=''; }
    function initPantry(){
      renderPantry();
      addPantryBtn.onclick = () => {
        const name = document.getElementById('pantryName').value.trim();
        const quantity = document.getElementById('pantryQty').value.trim();
        const expiry = document.getElementById('pantryExpiry').value;
        if (!name || !quantity){ alert('Please enter ingredient name and quantity.'); return; }
        const pantry = JSON.parse(localStorage.getItem('pantry') || '[]');
        if (editIndex !== null){ pantry[editIndex] = { name, quantity, expiry }; editIndex=null; addPantryBtn.textContent='Add Ingredient'; }
        else { pantry.push({ name, quantity, expiry }); }
        localStorage.setItem('pantry', JSON.stringify(pantry));
        renderPantry(); resetPantryForm();
      };
    }

    // ---------- Boot ----------
    if (!location.hash) location.hash = '#browse';
    updateUserUI();
    showRoute();
  </script>

  <noscript>Enable JavaScript to view the app.</noscript>
</body>
</html>
