<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecipeSite — Reset Password</title>

  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/login.css" />

  <style>
    .alert { margin-bottom: 12px; padding: 10px 12px; border-radius: 10px; border: 1px solid #f97373; background: #fef2f2; color: #7f1d1d; font-size: 0.9rem; }
  </style>

  <script>
    window.ENV_SUPABASE_URL = 'https://bhqeasmtrdfqncliipki.supabase.co/';
    window.ENV_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJocWVhc210cmRmcW5jbGlpcGtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNzQ4NzgsImV4cCI6MjA3NzY1MDg3OH0.249y8yGBYKgcvnoKkdTft94Mu74kbO_Ioso2HFrTFpg';
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
</head>

<body class="auth-body">
  <main class="auth-wrap">
    <div class="auth-card">
      <div class="auth-brand">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 3a1 1 0 0 0-1 1v2h10a1 1 0 1 1 0 2H7v2h8.5a3.5 3.5 0 1 1 0 7H12v2h4.5a5.5 5.5 0 0 0 0-11H6V4a1 1 0 0 1 1-1h1z"/></svg>
        <span>RecipeSite</span>
      </div>

      <h1 id="resetTitle">Reset your password</h1>
      <div id="message" class="alert" hidden></div>

      <section id="stepRequest">
        <p class="small muted">Enter your email and we’ll send you a link to choose a new password.</p>
        <form id="requestForm" class="auth-form" novalidate>
          <label class="field"><span>Email</span><input id="resetEmail" type="email" required placeholder="you@example.com" /></label>
          <button type="submit" class="btn full">Send reset link</button>
        </form>
      </section>

      <section id="stepUpdate" hidden>
        <p class="small muted">Enter your new password below.</p>
        <form id="updateForm" class="auth-form" novalidate>
          <label class="field"><span>New password</span><input id="newPw1" type="password" required placeholder="At least 6 chars" /></label>
          <label class="field"><span>Confirm password</span><input id="newPw2" type="password" required placeholder="Repeat password" /></label>
          <button type="submit" class="btn full">Update password</button>
        </form>
      </section>

      <div class="auth-footer">
        <a class="link" href="index.html">← Back to sign in</a>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* --- UI Helpers --- */
      const msgBox = document.getElementById('message');
      function showMsg(txt, err) {
        msgBox.hidden=false; msgBox.textContent=txt;
        msgBox.style.background=err?'#fef2f2':'#ecfdf5'; msgBox.style.color=err?'#7f1d1d':'#166534'; msgBox.style.borderColor=err?'#f97373':'#4ade80';
      }
      function clearMsg() { msgBox.hidden=true; msgBox.textContent=''; }

      /* --- Initialize Supabase --- */
      let supabase;
      try {
        supabase = window.supabase.createClient(window.ENV_SUPABASE_URL, window.ENV_SUPABASE_KEY, { 
          auth: { persistSession: true, autoRefreshToken: true } 
        });
      } catch(e) { showMsg('Supabase init failed. Check console.', true); return; }

      /* --- Logic --- */
      const stepRequest = document.getElementById('stepRequest');
      const stepUpdate  = document.getElementById('stepUpdate');
      const resetTitle  = document.getElementById('resetTitle');

      // 1. LISTEN for Auth State Changes (The most robust way)
      supabase.auth.onAuthStateChange(async (event, session) => {
        console.log('[Auth Event]', event);
        
        if (event === 'PASSWORD_RECOVERY') {
          // User clicked the email link
          stepRequest.hidden = true;
          stepUpdate.hidden = false;
          resetTitle.textContent = 'Choose a new password';
        } 
        else if (event === 'SIGNED_IN' && session) {
          // If they are already signed in, allow password change too
          stepRequest.hidden = true;
          stepUpdate.hidden = false;
        }
      });

      // 2. Handle "Send Link" Form
      document.getElementById('requestForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg();
        const email = document.getElementById('resetEmail').value.trim();
        if (!email) return showMsg('Please enter an email.', true);

        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          // IMPORTANT: This URL must be in your Supabase Dashboard -> Auth -> URL Configuration
          redirectTo: window.location.href 
        });

        if (error) showMsg(error.message, true);
        else showMsg('Check your email for the password reset link.', false);
      });

      // 3. Handle "Update Password" Form
      document.getElementById('updateForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        clearMsg();
        const p1 = document.getElementById('newPw1').value;
        const p2 = document.getElementById('newPw2').value;

        if (p1.length < 6) return showMsg('Password too short (min 6 chars).', true);
        if (p1 !== p2) return showMsg('Passwords do not match.', true);

        const { error } = await supabase.auth.updateUser({ password: p1 });

        if (error) {
          showMsg(error.message, true);
        } else {
          showMsg('Success! Redirecting to login...', false);
          setTimeout(() => window.location.href = 'index.html', 2000);
        }
      });
    });
  </script>
</body>
</html>
