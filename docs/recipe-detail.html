<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RecipeSite — Recipe</title>

  <link rel="stylesheet" href="css/base.css" />
  <link rel="stylesheet" href="css/recipe.css" />

  <!-- ENV -->
  <script>
    window.ENV_SUPABASE_URL = 'https://bhqeasmtrdfqncliipki.supabase.co/';
    window.ENV_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJocWVhc210cmRmcW5jbGlpcGtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwNzQ4NzgsImV4cCI6MjA3NzY1MDg3OH0.249y8yGBYKgcvnoKkdTft94Mu74kbO_Ioso2HFrTFpg';
  </script>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"
          onload="
            try {
              window.supabase = window.supabase.createClient(
                window.ENV_SUPABASE_URL,
                window.ENV_SUPABASE_KEY,
                { auth:{ persistSession:true, autoRefreshToken:true } }
              );
            } catch(e) { console.error('[supabase] init error', e); }
          "></script>

  <!-- Shared helpers -->
  <script src="js/common.js" defer></script>

  <style>
    body{
      background:radial-gradient(circle at top,#f5f3ff 0,#ffffff 40%,#f9fafb 100%);
    }
    .site-head{
      position:sticky;
      top:0;
      z-index:40;
      backdrop-filter:saturate(130%) blur(10px);
      background:color-mix(in oklab,var(--card,#fff),transparent 10%);
      border-bottom:1px solid #e5e7ebaa;
    }
    .site-head .wrap{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding-block:10px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      text-decoration:none;
      color:inherit;
      font-weight:700;
    }
    .brand span{letter-spacing:.03em;}
    .nav{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .nav a{
      padding:6px 10px;
      border-radius:999px;
      text-decoration:none;
      color:inherit;
      border:1px solid transparent;
      font-size:.9rem;
    }
    .nav a[aria-current="page"]{
      background:color-mix(in oklab,var(--accent,#16a34a),white 85%);
      border-color:#0001;
    }
    .head-search{
      flex:1;
      min-width:220px;
      max-width:420px;
    }
    .head-search input{width:100%;}
    .auth{
      min-width:120px;
      text-align:right;
      font-size:.9rem;
    }

    .alert{
      margin-bottom:16px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #fecaca;
      background:#fef2f2;
      color:#b91c1c;
    }

    .recipe-layout{
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .recipe-hero{
      border-radius:22px;
      overflow:hidden;
      border:1px solid #e5e7eb;
      box-shadow:0 14px 30px rgba(15,23,42,0.08);
      background:linear-gradient(145deg,#f9fafb,#ffffff);
    }
    .recipe-hero-media{
      position:relative;
      max-height:360px;
      overflow:hidden;
      background:#f3f4f6;
    }
    .recipe-hero-media img{
      width:100%;
      height:100%;
      max-height:360px;
      object-fit:cover;
      display:block;
    }
    .recipe-hero-fallback{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:60px 20px;
      color:#94a3b8;
      font-size:.95rem;
    }
    .recipe-hero-body{
      padding:18px 18px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .recipe-title-row{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .recipe-title-row h1{
      font-size:1.6rem;
      margin:0;
    }
    .pill-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .pill{
      border-radius:999px;
      padding:4px 9px;
      font-size:.8rem;
      background:#eef2ff;
      color:#4f46e5;
    }
    .pill.owner{
      background:#dcfce7;
      color:#166534;
    }
    .meta-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:.85rem;
      color:#6b7280;
      align-items:center;
    }

    .recipe-main{
      display:grid;
      grid-template-columns: minmax(0,2fr) minmax(260px,1fr);
      gap:18px;
      align-items:flex-start;
    }
    @media (max-width:900px){
      .recipe-main{
        grid-template-columns:1fr;
      }
    }
    .section-card{
      border-radius:18px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      padding:16px 18px;
      box-shadow:0 10px 24px rgba(15,23,42,0.06);
    }
    .section-card h2{
      margin:0 0 10px;
      font-size:1.1rem;
    }
    .ingredients-list,
    .steps-list{
      padding-left:1.2rem;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:.95rem;
    }
    .ingredients-list li,
    .steps-list li{
      margin:0;
    }

    .nutrition-list{
      list-style:none;
      padding:0;
      margin:0;
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px 10px;
      font-size:.9rem;
    }
    .nutrition-list li{
      display:flex;
      justify-content:space-between;
      background:#f9fafb;
      border-radius:10px;
      padding:6px 8px;
      border:1px solid #e5e7eb;
    }
    .nutrition-list span{
      color:#6b7280;
    }

    .tiny-label{
      text-transform:uppercase;
      font-size:.7rem;
      letter-spacing:.08em;
      color:#6b7280;
    }
    .aside-note{
      font-size:.85rem;
      color:#6b7280;
      margin-top:6px;
    }

    .btn.small{
      padding:5px 10px;
      font-size:.85rem;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const alertBox = document.getElementById('alert');
      const detailEl = document.getElementById('detail');

      const showAlert = (msg) => {
        alertBox.textContent = msg;
        alertBox.hidden = false;
      };
      const clearAlert = () => {
        alertBox.hidden = true;
        alertBox.textContent = '';
      };

      function getRecipeId() {
        const params = new URLSearchParams(location.search);
        return params.get('id');
      }

      async function loadRecipe() {
        const id = getRecipeId();
        if (!id) {
          showAlert('No recipe ID provided.');
          detailEl.innerHTML = '';
          return;
        }

        if (!window.supabase) {
          showAlert('Supabase client not ready.');
          return;
        }

        try {
          clearAlert();

          // 1) Current user (may be null)
          const { data: sessionRes, error: sessionErr } = await supabase.auth.getSession();
          if (sessionErr && sessionErr.message !== 'Auth session missing!') {
            console.warn('[getSession] error:', sessionErr.message);
          }
          const user = sessionRes?.session?.user || null;

          // 2) Load recipe (including user_id for ownership)
          const { data: recipe, error: rErr } = await supabase
            .from('recipes')
            .select('id, title, category, ingredients, steps, image, calories, protein, carbs, fat, user_id, created_at')
            .eq('id', id)
            .maybeSingle();

          if (rErr) throw new Error(rErr.message);
          if (!recipe) {
            showAlert('Recipe not found.');
            detailEl.innerHTML = '';
            return;
          }

          const isOwner = !!(user && recipe.user_id && user.id === recipe.user_id);
          const createdDate = recipe.created_at
            ? new Date(recipe.created_at).toLocaleDateString()
            : null;

          const ingredients = Array.isArray(recipe.ingredients) ? recipe.ingredients : [];
          const steps       = Array.isArray(recipe.steps)       ? recipe.steps       : [];

          let isFav = false;
          if (window.RecipeSite && RecipeSite.getFavSet) {
            isFav = RecipeSite.getFavSet().has(String(recipe.id));
          }

          const imgHtml = recipe.image
            ? `<img src="${recipe.image}" alt="${recipe.title}" loading="lazy" />`
            : `<div class="recipe-hero-fallback">No image for this recipe yet</div>`;

          const ownerChip = isOwner
            ? `<span class="pill owner">Your recipe</span>`
            : '';

          const createdChip = createdDate
            ? `<span class="pill">Added on ${createdDate}</span>`
            : '';

          const categoryChip = recipe.category
            ? `<span class="pill">${recipe.category}</span>`
            : '';

          const ownerActionsHtml = isOwner ? `
            <div class="row" style="margin-top: 8px; gap: 8px; align-items:center;">
              <button id="editRecipeBtn"
                      type="button"
                      class="btn outline">
                Edit recipe
              </button>
              <button id="deleteRecipeBtn"
                      type="button"
                      class="btn outline"
                      style="border-color:#dc2626;color:#b91c1c;">
                Delete recipe
              </button>
              <span class="small muted">Only you can see these buttons.</span>
            </div>
          ` : '';

          const nutritionHtml = `
            <ul class="nutrition-list">
              <li><span>Calories</span><strong>${recipe.calories ?? 0}</strong></li>
              <li><span>Protein</span><strong>${recipe.protein ?? 0} g</strong></li>
              <li><span>Carbs</span><strong>${recipe.carbs ?? 0} g</strong></li>
              <li><span>Fat</span><strong>${recipe.fat ?? 0} g</strong></li>
            </ul>
          `;

          const favLabel = isFav ? '✓ Saved' : '☆ Save';

          detailEl.innerHTML = `
            <div class="recipe-layout">
              <section class="recipe-hero">
                <div class="recipe-hero-media">
                  ${imgHtml}
                </div>
                <div class="recipe-hero-body">
                  <div class="recipe-title-row">
                    <div>
                      <h1>${recipe.title}</h1>
                      <div class="pill-row">
                        ${categoryChip}
                        ${ownerChip}
                        ${createdChip}
                      </div>
                    </div>
                    <div class="row" style="gap:8px; align-items:center;">
                      <button id="favToggle" type="button" class="btn small outline">
                        ${favLabel}
                      </button>
                      <a href="recipes.html#browse" class="btn small outline">← Back to recipes</a>
                    </div>
                  </div>

                  <div class="meta-row">
                    <span>Serves: <strong>4</strong></span>
                    <span>Prep &amp; cook: <strong>~45 mins</strong></span>
                  </div>

                  ${ownerActionsHtml}
                </div>
              </section>

              <section class="recipe-main">
                <!-- LEFT: ingredients + steps -->
                <div class="recipe-main-left" style="display:flex;flex-direction:column;gap:16px;">
                  <section class="section-card">
                    <h2>Ingredients</h2>
                    <ul class="ingredients-list">
                      ${ingredients.map(i => `<li>${i}</li>`).join('')}
                    </ul>
                  </section>

                  <section class="section-card">
                    <h2>Method</h2>
                    <ol class="steps-list">
                      ${steps.map(s => `<li>${s}</li>`).join('')}
                    </ol>
                  </section>
                </div>

                <!-- RIGHT: nutrition + notes -->
                <aside class="recipe-main-right" style="display:flex;flex-direction:column;gap:16px;">
                  <section class="section-card">
                    <h2>Nutrition</h2>
                    ${nutritionHtml}
                    <p class="aside-note">
                      Values are per serving and for general guidance only.
                    </p>
                  </section>

                  <section class="section-card">
                    <span class="tiny-label">Tip</span>
                    <p class="aside-note">
                      Save this recipe to favourites so you can quickly find it from the
                      <strong>Favourites</strong> tab next time.
                    </p>
                  </section>
                </aside>
              </section>
            </div>
          `;

          // Favourite toggle
          const favBtn = document.getElementById('favToggle');
          if (favBtn && window.RecipeSite && RecipeSite.toggleFav) {
            favBtn.addEventListener('click', async () => {
              try {
                const nowFav = await RecipeSite.toggleFav(String(recipe.id));
                favBtn.textContent = nowFav ? '✓ Saved' : '☆ Save';
              } catch (err) {
                console.error('[favToggle] error:', err);
                alert('Could not update favourites.');
              }
            });
          }

          // Edit / Delete buttons (owner only)
          const idStr = String(recipe.id);

          const editBtn = document.getElementById('editRecipeBtn');
          if (editBtn && isOwner) {
            editBtn.addEventListener('click', () => {
              window.location.href = 'add-recipe.html?id=' + encodeURIComponent(idStr);
            });
          }

const deleteBtn = document.getElementById('deleteRecipeBtn');
if (deleteBtn && isOwner) {
  deleteBtn.addEventListener('click', async () => {
    const ok = confirm('Delete this recipe? This cannot be undone.');
    if (!ok) return;

    const idStr = String(recipe.id);

    try {
      const { error: delErr } = await supabase
        .from('recipes')
        .delete()
        .eq('id', idStr);

      if (delErr) {
        console.error('[delete] error:', delErr);
        alert(
          'Could not delete recipe. Check Supabase policies & permissions.\n\n' +
          (delErr.message || 'Unknown error')
        );
        return;
      }

      window.location.href = 'recipes.html#browse';
    } catch (err) {
      console.error('[delete] unexpected error:', err);
      alert('Something went wrong deleting the recipe. See console for details.');
    }
  });
}


        } catch (e) {
          console.error(e);
          showAlert(e.message || String(e));
          detailEl.innerHTML = '';
        }
      }

      const check = setInterval(() => {
        if (window.supabase) {
          clearInterval(check);
          loadRecipe();
        }
      }, 100);
    });
  </script>
</head>
<body>
  <header class="site-head">
    <div class="container wrap">
      <a href="recipes.html#browse" class="brand">
        <svg viewBox="0 0 24 24" fill="currentColor" style="width:22px;height:22px;" aria-hidden="true">
          <path d="M8 3a1 1 0 0 0-1 1v2h10a1 1 0 1 1 0 2H7v2h8.5a3.5 3.5 0 1 1 0 7H12v2h4.5a5.5 5.5 0 0 0 0-11H6V4a1 1 0 0 1 1-1h1z"/>
        </svg>
        <span>RecipeSite</span>
      </a>

      <nav class="nav">
        <a href="recipes.html#browse">Browse</a>
        <a href="recipes.html#pantry">Pantry</a>
        <a href="recipes.html#favourites">Favourites</a>
      </nav>

      <div class="head-search">
        <input type="search" placeholder="Search all recipes..." disabled />
      </div>

      <div class="auth">
        <!-- common.js will populate -->
      </div>
    </div>
  </header>

  <main class="container" style="padding-top:24px;padding-bottom:24px;">
    <div id="alert" class="alert" hidden></div>
    <div id="detail">
      <!-- Filled by JS -->
      <p class="muted">Loading recipe...</p>
    </div>
  </main>
</body>
</html>
